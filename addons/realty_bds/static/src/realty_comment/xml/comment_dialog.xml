<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
	<t t-name="realty_bds.comment_dialog">
		<Dialog t-props="{'title': 'Comments'}" size="lg">
			<t t-if="state.topLevel.length === 0 &amp;&amp; !state.loading">
				<div class="text-center p-3">No comments yet. Be the first to comment!</div>
			</t>
			<t t-else="">
				<div class="o_comment_scroll">
					<div class="o_comment_scroll_header d-flex align-items-center">
						<!-- Left: sort select -->
						<div class="o_comment_sort">
							<label class="visually-hidden" for="comment_sort_select">Sort comments</label>
							<select id="comment_sort_select" class="form-select form-select-sm" t-on-change="(ev) =&gt; setSortMode(ev.target.value)" t-att-value="state.sortMode" aria-label="Sort comments">
								<option value="like" t-att-selected="state.sortMode === 'like'">By like</option>
								<option value="date_desc" t-att-selected="state.sortMode === 'date_desc'">By date (newest first)</option>
								<option value="date_asc" t-att-selected="state.sortMode === 'date_asc'">By date (oldest first)</option>
							</select>
						</div>

						<!-- Right: pager & controls -->
						<div class="o_comment_pager ms-auto d-flex align-items-center gap-2">
							<span t-ref="pageAnchor" t-on-click="openJumpDialog" style="cursor: pointer; user-select:none;">
								<t t-esc="state.page + 1"/>
								<t t-if="state.maxPage"> / <t t-esc="state.maxPage"/>
								</t>
							</span>

							<!-- Jump bubble -->
							<t t-if="state.jumpDialog.visible">
								<div class="jump-bubble" t-att-style="state.jumpDialog.style" role="dialog" aria-label="Jump to page">
									<div class="jump-bubble__tail" aria-hidden="true"></div>
									<div class="jump-bubble__content">
										<div style="font-size:0.85rem;">
            					Jump to page ...? (1-<t t-esc="state.maxPage"/>)
										</div>
										<input t-ref="jumpInput" class="form-control form-control-sm jump-bubble__input" type="text" t-att-value="state.jumpDialog.input" t-on-input="(ev) => state.jumpDialog.input = ev.target.value" t-on-keydown="onJumpKeydown" aria-label="Page number" />
										<div class="jump-bubble__error" t-if="state.jumpDialog.error">
											<t t-esc="state.jumpDialog.error"/>
										</div>
										<div class="jump-bubble__actions">
											<button type="button" class="btn btn-sm btn-outline-secondary ms-auto" t-on-click="closeJumpDialog">✕</button>
											<button type="button" class="btn btn-sm btn-primary" t-on-click="confirmJump">Go</button>
										</div>
									</div>
								</div>
							</t>

							<button type="button" class="btn btn-sm btn-light" t-att-disabled="state.loading || state.page == 0" t-on-click="loadPrevPage">&#10094;</button>
							<button type="button" class="btn btn-sm btn-light" t-att-disabled="state.loading || !state.hasMore" t-on-click="loadNextPage">&#10095;</button>
						</div>
					</div>

					<div class="o_comment_list">
						<t t-foreach="state.topLevel" t-as="cid" t-key="cid">
							<RealtyCommentItem 
								id="cid" 
								getComment="(id) =&gt; state.commentsById[id]" 
								level="0" 
								onReply="startReply" 
								onUpdated="_onCommentUpdated" 
								onDeleted="_onCommentDeleted" 
								replyingTo="state.replyingTo" 
								ctx="ctx" 
								getReplies="(pid) =&gt; state.repliesByParent[pid] || []" 
								loadReplies="(pid, page) =&gt; loadRepliesFor(pid, page)" 
								loadMoreReplies="(pid) =&gt; loadMoreRepliesFor(pid)" 
								toggleReplies="(pid) =&gt; toggleRepliesFor(pid)" 
								getRepliesMeta="(pid) =&gt; state.repliesMeta[pid] || {}" 
								isRepliesVisible="(pid) =&gt; !!state.showRepliesByParent[pid]" 
								onEditStart="(id) =&gt; startEditing(id)" 
								onEditCancel="() =&gt; cancelEditing()" 
								editingId="state.editingId" 
								enqueueAction="(tmpId, action) =&gt; _enqueueAction(tmpId, action)"
								validateContent="_contentValidation"
							/>
						</t>
					</div>
				</div>
			</t>

			<div class="o_comment_form mb-3 mt-3">
				<t t-if="state.replyingTo">
					<div class="replying-overlay d-flex align-items-center mb-2">
						<div class="replying-text">Replying to 
							<strong>
								<t t-esc="replyingToName"/>
							</strong>
						</div>
						<button type="button" class="btn btn-sm btn-outline-secondary ms-auto" t-on-click="cancelReply">✕</button>
					</div>
				</t>

				<div class="d-flex align-items-center w-100 comment-input-row" t-on-click="(ev) =&gt; ev.stopPropagation()">
					<input type="text" class="form-control flex-grow-1" t-att-placeholder="state.replyingTo ? 'Write a reply...' : 'Add a comment...'" t-ref="commentInput" t-on-keydown="handleKeydown" />
					<button type="button" class="btn btn-primary ms-2" t-on-click="createTopLevelComment" title="Send">
						<i class="fa fa-paper-plane" aria-hidden="true"/>
					</button>
				</div>

				<t t-if="state.replyingTo">
					<div t-on-click="cancelReply" class="reply-cancel-capture" aria-hidden="true"></div>
				</t>
			</div>
		</Dialog>
	</t>
</templates>